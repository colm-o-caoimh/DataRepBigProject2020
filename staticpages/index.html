<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" 
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">



    </head>
    <body>
        <div id="create-update" style="display:none"> 
            <h2>create-update</h2>
            <table id="createUpdateForm">
                <tr>
                    <!-- <td>id</td> -->
                    <td><input type="hidden" name="id" id="idInput"></td>
                </tr>
                <tr>
                    <td>title</td>
                    <td><input type="text" name="title" required></td>
                </tr>
                <tr>
                    <td>director</td>
                    <td><input type="text" name="director"></td>
                </tr>
                <tr>
                    <td>year</td>
                    <td><input type="text" name="year"></td>
                    <div id='message' style='visibility:hidden; height:150px; width: 250px; background-color: gray;' class="alert alert-primary" role="alert">
                            Please enter number
                      </div>
            
            
                </tr>
                <tr>
                    <td></td><td>
                        <button id="create-button" class="btn btn-primary" onclick="doCreate()">Create</button>
                        <button id="update-button" class="btn btn-secondary" onclick="doUpdate()">Update</button>
                    </td>
                </tr>
                <tr>
                    <td></td><td>
                        <button id="back-button" class="btn btn-warning btn-sm" onclick="goBack()">Back</button>
                    </td>
                </tr>
            </table>   
        </div>
        <div id="display">
            <h2>Movies</h2>
            <button onclick="showCreate()" class="btn btn-primary">Create</button>
            <table id="movieTable" class="table">
                <tr>
                    <th>ID</th><th>Title</th><th>Director</th><th>Year</th><th></th><th></th>
                </tr>
                     
            </table>

        </div>

        <script>
            function showCreate(){
                document.getElementById('display').style.display = "none"
                document.getElementById('update-button').style.display = "none"
                document.getElementById('create-button').style.display = "block"
                document.getElementById('create-update').style.display = "block"

            }

            function showUpdate(thisElem){
                var rowElement = thisElem.parentNode.parentNode
                //console.log(rowElement)
                movie = readMovieFromRow(rowElement)
                populateForm(movie)

                document.getElementById('display').style.display = "none"
                document.getElementById('update-button').style.display = "block"
                document.getElementById('create-button').style.display = "none"
                document.getElementById('create-update').style.display = "block"

            }

            function goBack(){
                document.getElementById('display').style.display = "block" //make visible
                document.getElementById('create-update').style.display = "none" //hide
            }

            function readMovieFromRow(rowElement){
                movie = {}
                movie.id = rowElement.getAttribute("id");
                movie.title = rowElement.cells[1].firstChild.textContent
                movie.director = rowElement.cells[2].firstChild.textContent
                movie.year = rowElement.cells[3].firstChild.textContent

                return movie
            }
 
            function populateForm(movie){
                var form = document.getElementById('createUpdateForm')

                form.querySelector('input[name="id"]').value = movie.id
                form.querySelector('input[name="id"]').disabled=true

                form.querySelector('input[name="title"]').value = movie.title
                form.querySelector('input[name="director"]').value = movie.director
                form.querySelector('input[name="year"]').value = movie.year

            }

            function clearForm(){
                var form = document.getElementById('createUpdateForm')

                form.querySelector('input[name="id"]').value = ''
                form.querySelector('input[name="id"]').disabled=false

                form.querySelector('input[name="title"]').value = ''
                form.querySelector('input[name="director"]').value = ''
                form.querySelector('input[name="year"]').value = ''

            }
 
            function doCreate(){
                host = window.location.origin

                movie = getMovieFromForm()
                console.log(movie.title)
                $.ajax({
                    // url:'http://127.0.0.1:5000/movies',
                    url:host + '/movies',
                    data:JSON.stringify(movie),
                    method:'POST',
                    dataType: 'JSON', // what we get back
                    contentType: "application/json; charset=utf-8",
                    success: function(result){
                        console.log(result) // if auto increment by id, returns id
                        movie.id = result
                        addMovieToTable(movie) // update to server first, then add to table
                        showDisplay()
                        clearForm()
                    },
                    error:function(xhr,status,error){
                        console.log("error"+error)
                    }
                })
            }


            
            
            function doUpdate(){
                movie = getMovieFromForm()
                updateServer(movie)
                
            }
            function updateServer(movie){
                host = window.location.origin
                $.ajax({
                    // url:'http://127.0.0.1:5000/movies/'+ movie.id,
                    url: host + '/movies/'+ movie.id,
                    data:JSON.stringify(movie),
                    method:'PUT',
                    dataType: 'JSON', // what we get back
                    contentType: "application/json; charset=utf-8",
                    success: function(result){
                        console.log(result) // if auto increment by id, returns id
                        updateTableRow(movie)
                        showDisplay()
                        clearForm()
                    },
                    error:function(xhr,status,error){
                        console.log("error"+error)
                    }
                })
            }    
            function doDelete(thisElem){
                host = window.location.origin
                var tableElement = document.getElementById('movieTable')
                var rowElement = thisElem.parentNode.parentNode
                var index = rowElement.rowIndex
                id = rowElement.getAttribute("id");
                console.log(id)
                $.ajax({
                    // url: 'http://127.0.0.1:5000/movies/'+ id,
                    url: host + '/movies/'+ id,
                    method: 'DELETE',
                    dataType: 'JSON',
                    success:function(result){
                        tableElement.deleteRow(index)
                        console.log(result)
                    },
                    error:function(xhr,status,error){
                        console.log(error)
                    }
                })
            }

            function updateTableRow(movie){
                rowElement = document.getElementById(movie.id)
                rowElement.cells[1].firstChild.textContent = movie.title
                rowElement.cells[2].firstChild.textContent = movie.director
                rowElement.cells[3].firstChild.textContent = movie.year
                console.log("updating table")

            }
            
            function getMovieFromForm(){ //form on the create-update screen
                var form = document.getElementById('createUpdateForm')
                var text;

                var movie = {}
                movie.id = form.querySelector('input[name="id"]').value
                form.querySelector('input[name="id"]').disabled=true

                movie.title = form.querySelector('input[name="title"]').value
                movie.director = form.querySelector('input[name="director"]').value
                movie.year = form.querySelector('input[name="year"]').value
                if (isNaN(movie.year)){
                    text = "input not valid - please enter year"
                    document.getElementById('message').innerHTML = text;
                    setTimeout("showDiv()", 3000)
                    showDiv()
                }else {
                console.log(movie)
                return movie
                }
            }
 
            function showDiv(){
                document.getElementById('message').style.visibility="hidden";
            }
                

            function showDisplay(){
                document.getElementById('display').style.display = "block" //make visible
                document.getElementById('create-update').style.display = "none" //hide

            }
            
        
        
            function populateTable(){
                host = window.location.origin
                //ajax call to database (via server) to getAll books. That's why we need an ajx call
                $.ajax({ // jQuery ajax() method
                    // url:'http://127.0.0.1:5000/movies', //send request here
                    url: host + '/movies',
                    method: 'GET',
                    dataType: 'JSON', //data type expected of server response
                    success: function(results){ // special ajax object success function to run when request succeeds
                        for (movie of results)
                            addMovieToTable(movie)
                        },
                    error: function (xhr,atatus,error){ // special ajax error function when request fails
                        console.log ("error "+error +" code:"+code)
                    }
                    
                })

            }
            function addMovieToTable(movie){
                //console.log("working so far")
                tableElem = document.getElementById("movieTable")
                rowElem = tableElem.insertRow(-1) // -1 inserts row at the end
                rowElem.setAttribute("id", movie.id) // we can find this row easily when we want to delete it
                cell1 = rowElem.insertCell(0)
                cell1.innerHTML = movie.id
                cell2 = rowElem.insertCell(1)
                cell2.innerHTML = movie.title
                cell3 = rowElem.insertCell(2)
                cell3.innerHTML = movie.director
                cell4 = rowElem.insertCell(3)
                cell4.innerHTML = movie.year
                cell5 = rowElem.insertCell(4)
                cell5.innerHTML = '<button onclick="showUpdate(this)" class="btn btn-secondary">Update</button>'
                cell6 = rowElem.insertCell(5)
                cell6.innerHTML = '<button onclick="doDelete(this)" class="btn btn-secondary">Delete</button>'
            }
            populateTable() //this is called as soon as program is run
        </script>
    </body>
</html>